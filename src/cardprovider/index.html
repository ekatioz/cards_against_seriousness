<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Card Provider</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" media="screen" href="cardprovider.css" />
</head>

<body>
  <div class="whites">
    <h1>Whitecards</h1>
    <textarea class="textInput" id="whiteText"></textarea>
    <button id="addWhite">hinzuf√ºgen</button>
    <br>
    <div id="list"></div>
  </div>

  <div class="blacks">
    <h1>Blackcards</h1>
    <textarea class="textInput" id="blackText"></textarea>
    <button id="addGap">L√ºcke einf√ºgen</button>
    <button id="addPlayerGap">Spielername einf√ºgen</button>
    <button id="addBlack">hinzuf√ºgen</button>
    <br>
    <div id="listBlack"></div>
  </div>

  <script>

    var list = document.getElementById("list");
    var listBlack = document.getElementById("listBlack");
    var addWhite = document.getElementById("addWhite");
    var addBlack = document.getElementById("addBlack");
    var whiteText = document.getElementById("whiteText");
    var blackText = document.getElementById("blackText");
    var addGap = document.getElementById("addGap");

    function addEntry(list, element, type) {
      var entry = document.createElement('div');
      var deleteBtn = document.createElement('button');
      deleteBtn.className = "deleteBtn";
      deleteBtn.innerText ="l√∂schen";
      deleteBtn.addEventListener("click", () => fetch(`/delete?id=${element._id}&type=${type}`).then(() => update(type)));
      entry.className = 'entry';
      entry.innerText = element.value;
      entry.appendChild(deleteBtn);
      list.appendChild(entry);
    }

    function update(type) {
      fetch(`/cards?type=${type}`).then(res => {
        console.log(type);
        if (type === 'whitecard') {
          list.innerHTML = '';
          whiteText.value = '';
          res.json().then(json => json.forEach(element => addEntry(list, element, type)));
        } else {
          listBlack.innerHTML = '';
          blackText.value = '';
          res.json().then(json => json.forEach(element => {
            element.value = element.value.replace(/\%w/g, 'üí£');
            element.value = element.value.replace(/\%p/g, 'üòé');

            addEntry(listBlack, element, type)
          }));
        }
      })
    }

    const escape = (value) => value.replace(/üí£/g, '%25w').replace(/üòé/g, '%25p');

    addGap.addEventListener('click', (e) => {
      blackText.value = blackText.value + 'üí£';
      blackText.focus();
    });
    addPlayerGap.addEventListener('click', (e) => {
      blackText.value = blackText.value + 'üòé';
      blackText.focus();
    });
    addWhite.addEventListener('click', (e) => {
      if (whiteText.value !== '') {
        fetch(`/provide?text=${whiteText.value}&type=whitecard`).then(() => update('whitecard'));
      }
    });
    addBlack.addEventListener('click', (e) => {
      if (blackText.value !== '') {
        fetch(`/provide?text=${escape(blackText.value)}&type=blackcard`).then(() => update('blackcard'));
      }
    });
    update('whitecard');
    update('blackcard'); 
  </script>
</body>

</html>
